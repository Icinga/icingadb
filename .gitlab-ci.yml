variables:
  REPO_THING: git.icinga.com/icingadb

stages:
    - build
    - build-image

build:
  stage: build
  image: golang:latest
  before_script:
    - mkdir -p $GOPATH/src/$REPO_THING
    - ln -svf $CI_PROJECT_DIR $GOPATH/src/$REPO_THING
    - cd $GOPATH/src/$REPO_THING/$CI_PROJECT_NAME
    - git config --global url."https://gitlab-ci-token:${CI_JOB_TOKEN}@git.icinga.com/".insteadOf "https://git.icinga.com/"
  script:
    - gitlab-ci/assert-go-fmt.sh
    - go get .
    - go build -x -v .
  artifacts:
    paths:
      - icingadb-main
      
build-image:
  variables:
    CONTAINER: $CI_REGISTRY/$CI_PROJECT_PATH/$CI_COMMIT_REF_SLUG
  stage: build-image
  dependencies:
    - build
  tags:
    - docker-build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
  script:
    - docker pull $CONTAINER || true
    - docker build -f gitlab-ci/Dockerfile --pull --cache-from $CONTAINER -t $CONTAINER .
    - docker push $CONTAINER

