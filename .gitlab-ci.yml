variables:
  REPO_THING: git.icinga.com/icingadb

stages:
    - build
    - build-image
    - deploy-image

build:
  stage: build
  image: golang:latest
  before_script:
    - mkdir -p $GOPATH/src/$REPO_THING
    - ln -svf $CI_PROJECT_DIR $GOPATH/src/$REPO_THING
    - cd $GOPATH/src/$REPO_THING/$CI_PROJECT_NAME
    - git config --global url."https://gitlab-ci-token:${CI_JOB_TOKEN}@git.icinga.com/".insteadOf "https://git.icinga.com/"
  script:
    - gitlab-ci/assert-go-fmt.sh
    - go get .
    - go build -x -v .
  artifacts:
    paths:
      - icingadb-main
      
build-image:
  variables:
    CONTAINER: $CI_REGISTRY/$CI_PROJECT_PATH/$CI_COMMIT_REF_SLUG
  stage: build-image
  dependencies:
    - build
  tags:
    - docker-build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
  script:
    - docker pull $CONTAINER || true
    - docker build -f gitlab-ci/Dockerfile --pull --cache-from $CONTAINER -t $CONTAINER .
    - docker push $CONTAINER

deploy-image-1: &deploy-image-base
  variables:
    SSH_ADDR: 10.77.27.18
  stage: deploy-image
  dependencies:
    - build-image
  only:
    - master
  image: $CI_REGISTRY/icingadb/docker/master-deploy:latest
  script:
    - cat <<<"$SSH_PRIVKEY" >./deploy.sshkey
    - chmod 0600 ./deploy.sshkey
    - >
      ssh -i ./deploy.sshkey -o StrictHostKeyChecking=no $SSH_ADDR
      "docker login -u $GITLABCI_USER -p $GITLABCI_TOKEN $CI_REGISTRY
      && cd /root/icingadb
      && docker-compose pull icingadb
      && DOCKER_SERVICE=icingadb
      CI_COMMIT_SHA=$CI_COMMIT_SHA
      CI_COMMIT_AUTHOR='$(git log -1 --format=%an $CI_COMMIT_SHA)'
      CI_COMMIT_TITLE=\"\$(base64 -d <<<'$(base64 <<<"$CI_COMMIT_TITLE")')\"
      /root/icingadb/docker-compose-up.py >>messages"
    - rm ./deploy.sshkey

deploy-image-2:
  <<: *deploy-image-base
  variables:
    SSH_ADDR: 10.77.27.16

